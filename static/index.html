<!doctype html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="stylesheet" href="/codemirror/lib/codemirror.css">
        <link rel="stylesheet" href="/codemirror/addon/lint/lint.css">
        <script type="text/javascript" src="/codemirror/lib/codemirror.js"></script>
        <script type="text/javascript" src="/codemirror/addon/mode/simple.js"></script>
        <script type="text/javascript" src="/editor.js"></script>
        <meta charset="utf-8">
        <title>Biscuit tokens playground by Clever Cloud</title>
        <script type="module">
            /*import init from "./wasm.js"
            init()*/
        </script>
    </head>
    <body>
      <div>
        <div id="header">
            <a href="https://www.clever-cloud.com/"><img src="/logo.svg" /></a>
            <h2>Biscuit Token playground</h2>
        </div>
        <div id="biscuit-wrapper">
            <div id="explain">
                <p>This is a live demo of the <a href="https://github.com/CleverCloud/biscuit">Biscuit authentication and authorization tokens</a>,
                  where you can test different authorization policies. Each token
                  is made of blocks, each block represents one attenuation level:
                  you can restrict the rights of a token by adding a new block.
                  Authorization policies are written in Datalog, where facts represent
                  data, rules generate more facts from existing facts, and checks
                  validate the presence of some facts. To pass the verification
                  phase, all of the checks must succeed.
                </p>
                <p>Test the behaviour of the example token by activating or
                  deactivating blocks or their data, changing conditions (like
                  <em>#read</em> operation to <em>#write</em> and see how the verifier will react)</p>
            </div>

            <div id="token" class="container">
                <h3>{"Token"}</h3>
                <ul id="block-list">
                  <li class={ if is_enabled { "sub-container" } else { "sub-container block-disabled" } }>
                    <div class="block">
                        <div>
    
                            <span>
                                <button onclick=self.link.callback(move |_| {
                                    Msg::DeleteBlock { block_index }
                                })
                                    hidden = { block_index == 0 }
                                >{ "-" }</button>
                                <input type="checkbox"
                                    onclick = self.link.callback(move |_| {
                                        Msg::SetBlockEnabled {enabled: !is_enabled, block_index }
                                    })
                                    checked = { is_enabled }
                                    hidden = { block_index == 0 }
                                />
                                <h4 style="display:inline">{ if block_index == 0 {
                                    "Authority block".to_string()
                                } else {
                                    format!("Block {}", block_index)
                                }
                                }</h4>
                            </span>
                            <br />
                        </div>
    
                        <textarea
                            class="code-buffer"
                            style="display: none"
                            id={ format!("block-code-{}-buffer", block_index) }
                            oninput=self.link.callback(move |e: InputData| {
                                Msg::UpdateBlockCode { block_index, value: e.value }
                            })
                        >{ &block.code }</textarea>
                        <textarea
                            class="code"
                            id={ format!("block-code-{}", block_index) }
                        ></textarea>
                    </div>
                </li>
                    
                    <li><button onclick="">Add Block</button></li>
                </ul>
                <div class="sub-container">
                    <em>{"Token content "}</em>
                    <input
                        type="text"
                        size="45"
                        value ="self.token.serialized.as_deref().unwrap_or"
                    />
                    <pre id="token-content">
                      self.token.biscuit.as_ref().map(|b| b.print()).unwrap_or_else(String::new)
                    </pre>
                </div>
            </div>
            <div id="verifier" class="container">
              <h3>{"Verifier"}</h3>

              <div class="sub-container">
                  <textarea
                      class="code-buffer"
                      id = "verifier-code-buffer"
                      style="display: none"
                      oninput=self.link.callback(move |e: InputData| {
                          Msg::UpdateVerifierCode { value: e.value }
                      })
                  >{ &verifier.code }</textarea>
                  <textarea
                      class="code"
                      id = "verifier-code"
                  ></textarea>
              </div>

              <div class="sub-container">
                  <h4>{"Verifier result"}</h4>
                  <p id="verifier-result">{ match &verifier.error {
                      Some(e) => format!("Error: {:?}", e),
                      None => "Success".to_string(),
                  } }</p>

                  <pre id="verifier-world">{ &verifier.output }</pre>
              </div>

          </div>
        </div>
    </div>  
      <script>
        window.editors = {};
        window.marks = [];

        function setup_codemirror() {
          var current_editors = Object.keys(window.editors);
          var new_editors = [];

          var elements = document.getElementsByClassName('code');
          for (var i=0, len=elements.length|0; i<len; i=i+1|0) {
              var editor = elements[i];
              new_editors.push(editor.id);

              let buffer_editor = document.getElementById(editor.id+"-buffer");
              editor.value = buffer_editor.value;

            if(!current_editors.includes(editor.id)) {
              let cm = new CodeMirror.fromTextArea(document.getElementById(editor.id), {
                mode: 'biscuit',
                autoCloseTags: true,
                lineNumbers: true
              });

              let id = editor.id;

              function updateTextArea() {
                console.log("trying to save");
                // somehow save() does not work
                //cm.save();
                var text = cm.getValue();

                let editor = document.getElementById(id+"-buffer");
                editor.innerText = text;

                const event = new Event('input');
                editor.dispatchEvent(event);
              }
              cm.on('change', updateTextArea);

              //cm.addLineClass(3, "text", "caveat_success");
              //var mark = cm.markText({line: 2, ch:2}, {line:3, ch:5}, { css: "background: #c1f1c1;" });
              window.editors[editor.id] = cm;
              //window.marks.push(mark);
            }
            //result += "\n  " + allOrangeJuiceByClass[i].textContent;
          }

          for(var i=0; i < current_editors.length; i=i+1) {
            if(!new_editors.includes(current_editors[i])) {
              delete window.editors[current_editors[i]];
            }
          }

          //console.log(window.editors);
        }

        setup_codemirror();
        setInterval(setup_codemirror, 2000);
      </script>
    </body>
</html>
